# CDC控制系统 - 架构设计文档

## 1. 系统概述

CDC控制系统采用分层架构设计，将系统划分为表示层、业务逻辑层、数据访问层和硬件抽象层。

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────┐
│                     表示层 (UI Layer)                    │
│  ┌──────────┬──────────┬──────────┬──────────┬────────┐│
│  │Serial    │Motor     │Sensor    │Log       │Data    ││
│  │Comm      │Control   │Monitor   │Viewer    │Viz     ││
│  └──────────┴──────────┴──────────┴──────────┴────────┘│
├─────────────────────────────────────────────────────────┤
│                 业务逻辑层 (Core Layer)                  │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │Motor     │Sensor    │Safety    │Data              │ │
│  │Controller│Manager   │Manager   │Recorder          │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│                 数据层 (Data Layer)                      │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │Data      │Export    │File      │CSV               │ │
│  │Processor │Manager   │Manager   │Analyzer          │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
├─────────────────────────────────────────────────────────┤
│              硬件抽象层 (Hardware Layer)                 │
│  ┌──────────┬──────────┬──────────┬──────────────────┐ │
│  │Serial    │Motor     │Sensor    │Command           │ │
│  │Interface │Interface │Interface │Protocol          │ │
│  └──────────┴──────────┴──────────┴──────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 3. 模块设计

### 3.1 UI模块 (ui/)

**职责**：
- 用户界面展示
- 用户交互处理
- 数据可视化

**主要组件**：
- `MainWindow`: 主窗口，包含5个功能页面
- `ChartDisplayWidget`: 2D图表显示
- `Chart3DWidget`: 3D图表显示（使用Qt3D）
- `DataVisualizationWidget`: 数据可视化控制

### 3.2 核心模块 (core/)

**职责**：
- 业务逻辑处理
- 设备控制
- 数据管理

**主要组件**：
- `MotorController`: 电机控制逻辑
- `SensorManager`: 传感器数据管理
- `SafetyManager`: 安全限位管理
- `DataRecorder`: 数据记录管理

### 3.3 数据模块 (data/)

**职责**：
- 数据处理与分析
- 文件I/O操作
- 数据导入导出

**主要组件**：
- `DataProcessor`: 数据处理算法
- `ExportManager`: 数据导出管理
- `CsvAnalyzer`: CSV数据分析
- `FileManager`: 文件操作管理

### 3.4 硬件模块 (hardware/)

**职责**：
- 硬件通信接口
- 协议实现
- 设备抽象

**主要组件**：
- `SerialInterface`: 串口通信接口
- `CommandProtocol`: 通信协议实现
- `MotorInterface`: 电机接口
- `SensorInterface`: 传感器接口

### 3.5 模型模块 (models/)

**职责**：
- 数据模型定义
- 配置管理

**主要组件**：
- `MeasurementData`: 测量数据模型
- `SensorData`: 传感器数据模型
- `DeviceInfo`: 设备信息模型
- `SystemConfig`: 系统配置单例

### 3.6 工具模块 (utils/)

**职责**：
- 通用工具函数
- 日志管理
- 数学计算

**主要组件**：
- `Logger`: 日志管理器（单例）
- `MathUtils`: 数学工具函数
- `ConfigManager`: 配置文件管理

## 4. 设计模式

### 4.1 单例模式 (Singleton)
- `SystemConfig`: 全局配置管理
- `Logger`: 日志管理器

### 4.2 观察者模式 (Observer)
- 串口数据接收回调
- 传感器数据更新通知
- UI事件处理

### 4.3 策略模式 (Strategy)
- 不同的图表类型渲染策略
- 数据导出格式策略

### 4.4 工厂模式 (Factory)
- 设备创建工厂
- 图表创建工厂

## 5. 数据流

### 5.1 控制命令流
```
UI输入 → MotorController → SerialInterface → MCU
```

### 5.2 传感器数据流
```
MCU → SerialInterface → SensorManager → UI显示/DataRecorder
```

### 5.3 数据分析流
```
CSV文件 → CsvAnalyzer → DataProcessor → ChartWidget → UI显示
```

## 6. 线程模型

- **主线程**: UI渲染和用户交互
- **串口线程**: 串口数据收发
- **数据处理线程**: 大数据集分析处理
- **自动保存线程**: 定期自动保存数据

## 7. 错误处理

### 7.1 错误级别
- `ERROR`: 系统错误，需要立即处理
- `WARNING`: 警告信息，可能影响功能
- `INFO`: 普通信息
- `DEBUG`: 调试信息

### 7.2 错误处理策略
- 硬件通信错误：重试机制 + 用户通知
- 数据验证错误：拒绝操作 + 错误提示
- 文件操作错误：备份机制 + 恢复选项

## 8. 性能优化

### 8.1 数据缓存
- 传感器数据缓存
- 图表数据缓存
- 统计结果缓存

### 8.2 延迟加载
- 大文件分块加载
- 图表数据按需渲染

### 8.3 内存管理
- 智能指针管理资源
- 数据压缩存储
- 定期清理过期数据

## 9. 扩展性设计

### 9.1 插件接口
- 支持自定义数据处理算法
- 支持新的传感器类型
- 支持自定义导出格式

### 9.2 配置驱动
- 通信协议可配置
- UI布局可配置
- 数据处理参数可配置

## 10. 安全性考虑

### 10.1 数据安全
- 数据完整性校验
- 操作日志记录
- 数据备份机制

### 10.2 操作安全
- 安全限位检查
- 紧急停止机制
- 操作权限控制